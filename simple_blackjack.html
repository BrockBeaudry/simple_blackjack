<script> 

    // Top-level namespace
    var blackjack = blackjack || {};

    // Nested namespace for core card game functionality
    blackjack.cardBase = blackjack.cardBase || {};

    // Freeze enums to emulate immutability
    blackjack.cardBase.SuitEnum = Object.freeze({
            Hearts: 'Hearts', Diamonds: 'Diamonds', Clubs: 'Clubs', Spades: 'Spades'
    });

    blackjack.cardBase.RankEnum =  Object.freeze({
            Ace: 1, Two: 2, Three: 3, Four: 4, Five: 5, Six: 6, Seven: 7, Eight: 8, 
            Nine: 9, Ten: 10, Jack: 11, Queen: 12, King: 13
    });

    blackjack.cardBase.NameEnum = Object.freeze({
            1: 'Ace', 2: 'Two', 3: 'Three', 4: 'Four', 5: 'Five', 6: 'Six', 7: 'Seven', 
            8: 'Eight', 9: 'Nine', 10: 'Ten', 11: 'Jack', 12: 'Queen', 13: 'King'
    });

    blackjack.cardBase.Card = function(rank, suit) {
        this.rank = rank;
        this.suit = suit;
    }

    blackjack.cardBase.Card.prototype.toString = function() {
        return blackjack.cardBase.NameEnum[this.rank] + " of " + this.suit;
    }

    // A standard 52-card French deck
    blackjack.cardBase.Deck = function() {
        this.cards = [];

        Object.defineProperties(this, {
            "count": {
                "get": function() { return this.cards.length; }
            }
        });

        // Populate the cards array
        this.init = function() {

            // Sibling namespace
            var ns = blackjack.cardBase;

            for(var s in ns.SuitEnum) {
                for(var r in ns.RankEnum) {
                    this.cards.push(new ns.Card(ns.RankEnum[r], s));
                }
            }
        }

        // Automatically initialize new instances
        this.init();
    }

    blackjack.cardBase.Player = function(name) {
        this.name = name;
        this.hand = [];

        // Print the players hand to the console
        this.showHand = function() {
            console.log(this.name + '\'s hand: ');

            this.hand.forEach(function(card) {
                console.log(card.toString());
            });
        }
    }

    blackjack.cardBase.Dealer = function(name) {

        // Invoke parent constructor
        blackjack.cardBase.Player.call(this, name);

        this.deck = new blackjack.cardBase.Deck();

        // Fisher-Yates shuffle algorithm
        this.shuffleDeck = function() {
            var deck = this.deck.cards;

            for (var i = deck.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = deck[i];

                deck[i] = deck[j];
                deck[j] = temp;
            }

            this.deck.cards = deck;;
        }

        this.deal = function(player) {
            topCard = this.deck.cards.shift();
            player.hand.push(topCard);
        }

        // Automatically shuffle new instances
        this.shuffleDeck();
    }
 
    blackjack.cardBase.Dealer.prototype = Object.create(blackjack.cardBase.Player.prototype);

    blackjack.cardBase.showDeck = function(deck) {
        deck.cards.forEach(function(card) {
            console.log(card.toString());
        });
    }

    // Nested namespace for blackjack specific extensions of the card base
    blackjack.game = {};

    // Returns the point value of a players hand
    blackjack.game.handValue = function(hand) {
        var sum = 0, aces = 0;

        hand.forEach(function(card) {
            // If the card is an ace wait to determine if soft or hard
            if (card.rank === blackjack.cardBase.RankEnum.Ace) {
                aces++;
                console.log('ACE!');
            }
            // Add 10 for a face card
            else if (card.rank >= blackjack.cardBase.RankEnum.Ten) {
                sum += blackjack.cardBase.RankEnum.Ten;
            }
            // Otherwise just add the rank
            else {
                sum += card.rank;
            }
        });

        // If the point value won't exceed 21
        if(aces === 1 && sum <= 10)
            // Soft ace
            return sum + blackjack.cardBase.RankEnum.Jack;

        // Otherwise hard ace(s)
        return sum + aces;
    }

    blackjack.game.dealCard = function(dealer, player) {
        dealer.deal(player);
    }

    blackjack.game.dealCards = function(dealer, players, numberOfCards) {
            for(var i = 0; i < numberOfCards; i++) {
                for(var j = 0; j < players.length; j++) {
                        dealer.deal(players[j]);
                }
            }
    }

    blackjack.game.displayHands = function(players) {
        console.clear();

        players.forEach(function(player) {
            player.showHand(); 
            console.log('Total: ' + blackjack.game.handValue(player.hand));
            console.log('\n');
        });
    }

    // Sort hands in descending order
    blackjack.game.compareHandsForSort = function(first, second) {
        handOne = blackjack.game.handValue(first.hand);
        handTwo = blackjack.game.handValue(second.hand);

        if(handOne == handTwo)
                return 0;
        if(handOne < handTwo)
                return 1;
        else
                return -1;
    }

    blackjack.game.play = function() {
        var game = blackjack.game, base = blackjack.cardBase;
        var players = [], startingCards = 2, bustLimit = 21, dealerHitLimit = 17;

        var dealer = new base.Dealer('Joe Dealer');

        players.push(new base.Player(prompt("What's your name?")));
        players.push(dealer);

        game.dealCards(dealer, players, startingCards);

        game.displayHands(players);

        players.forEach(function(player) {
            if(!(player instanceof base.Dealer))
            {

                while(game.handValue(player.hand) < bustLimit) {
                    if(confirm('Press OK to hit, cancel to stand.')){
                        game.dealCard(dealer, player);

                        game.displayHands(players);
                    }
                    else
                        break;
                }
            }
        });

        while(game.handValue(dealer.hand) < dealerHitLimit) {
            game.dealCard(dealer, dealer);
        }

        game.displayHands(players);

        // Sort players by total points from high to low
        players = players.sort(game.compareHandsForSort);

        // Find the first player that hasn't busted
        var winner = players.filter(function(player) {
                return (game.handValue(player.hand) <= bustLimit);
            }).shift();

        if(winner)
                console.log(winner.name + " won!");
        else
                console.log("No winners here!");

    }

    blackjack.game.play();

</script>